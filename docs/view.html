<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View | Public Webpages | Section 508 Pro</title>
    <script src="assets/uswds/dist/js/uswds-init.min.js"></script>
    <link rel="stylesheet" href="assets/uswds/dist/css/uswds.min.css" />
    
    <script src="components/agency-nav/index.js"></script>
    <script src="components/wcag-form/index.js"></script>
    <script src="components/error-table/index.js"></script>
    <script src="components/wcag-errors/index.js"></script>
    

    <style>
      table, tr, td, th {
        border: black 1px solid;
        border-collapse: collapse;
        padding: 0.5em;
      }

      td{
        text-align: right;
      }

      th{
        font-weight: bold;
      }

      summary > h3 {
        display: inline-block;
      }

      summary > h4 {
        display: inline-block;
        text-indent: 2em;
      }

      summary > h5 {
        display: inline-block;
        text-indent: 4em;
      }

      .pass {
        color: green;
      }

      .fail {
        color: red;
      }

      .na {
        color: gray;
      }

      ul.wcag-state {
        list-style-type: none;
      }

      ul.wcag-state > li{
        display: "inline-block";
        padding: 0;
        font-weight: "bold";
      }

    </style>
    
    <script>
      window.addEventListener('load', init);

      function init(){
        window.addEventListener('newdata', updateWcagErrors);
        update(getQS("website")); 
      }

      /**
       * Get a value from the querystring
       */
      function getQS(key){
        const querystring = new URLSearchParams(document.location.search);
        return querystring.get(key);
      }

      function updateWcagErrors(event){
        if(event.detail.key == "jsonA11yErrors"){
          console.log(event);
          let table = document.querySelector(`#wcagErrorsTable`);          
          
          // reset tbody
          let tbody = document.querySelector(`#wcagErrorsTable > tbody`);
          tbody.remove();
          tbody = document.createElement('tbody');
          tbody.setAttribute('data-website', getQS('website'));

          // populate data
          let errors = event.detail.json;
          let errorCount = 0;          
          errors.forEach((err) => {
            let wcags = lh2wcag(err.id);
            wcags.forEach((wcag) => {
              let tr = tbody.insertRow();
              let error = tr.insertCell();
              error.appendChild(document.createTextNode(wcag));
              let count = tr.insertCell();
              count.appendChild(document.createTextNode(err.errorCount));
              let rules = tr.insertCell();
              rules.appendChild(document.createTextNode(err.id));

              errorCount += err.errorCount;
            });
          });
          table.appendChild(tbody);

          // update summary with errorCount          
          let summary = document.querySelector(`#wcagErrorsSummary`);
          summary.innerHTML = `<h3>Errors: ${errorCount}</h3>`;
          if(errorCount > 0){
              summary.classList.add('fail');
          }else{
              summary.classList.add('pass');
          }
        }        
      }

      /**
       * Updates the page with new data
       */
      function update(website){
        reset();
        fetchData();
        let details = getDetails();
        
        let sidebarMenu = document.querySelector(`#${website}`);
        if(sidebarMenu){
          // 1. show current on agency sidebar nav
          sidebarMenu.classList.add("usa-current");
        
          // 2. change main header
          let header = document.querySelector("#main-header");
          header.innerHTML = sidebarMenu.innerHTML;

          // 3. load Lighthouse HTML report
          let lighthouseHtml = document.querySelector("#lighthouse-html");
          lighthouseHtml.src = details.get("htmlLighthouse");

        }else{
          console.error(`No website found for website=${website}`);
        }
      }

      /**
       * Resets the page to a new, empty state
       */
      function reset(){
        // 1. UNDO show current on agency sidebar nav
        let currents = document.querySelectorAll(".usa-current");
        if(currents){
          currents.forEach((current) => {
            current.classList.remove("usa-current");
          });
        }
        
        // 2. UNDO change main header
        let header = document.querySelector("#main-header");
        header.innerHTML = "";

        // 3. UNDO load Lighthouse HTML report
        let lighthouseHtml = document.querySelector("#lighthouse-html");
        lighthouseHtml.src = '';

        // 4. reset wcagErrorTable
        let errorTableWcag = document.querySelector("#errorTableWcag");
        // errorTableWcag.remove();

        // 5. reset lhErrorTable
        let errorTableLh = document.querySelector("#errorTableLh");
        // errorTableLh.remove();
      }

      /**
       * Fetches all data need to update the page
       */
      async function fetchData(){
        const details = getDetails();
        console.log(details);

        fetchJson("jsonAllPages");
        fetchJson("jsonA11y");
        fetchJson("jsonA11yErrors");

        let promises = [];
        promises.push(saveJson("jsonErrorsSummaryLighthouse"));
        promises.push(saveJson("jsonErrorsSummaryWcag"));
        promises.push(saveJson("jsonLighthouse"));
        
        

        Promise.all(promises)
          .then((responses) => {
            return;
          })
          .catch((error) => {
            console.error(`Fetch ERROR: ${getQS("website")} - ${error}`);
          });
      }

      /**
       * Returns parameters needed to update the data:
       *  - Agency ("cns")
       *  - Type ("mobile" | "desktop")
       *  - Date ("2023-08-31")
       *  - Page ("/about")
       */
      function getDetails(){
        let details = new Map();
        
        // agency
        let website = getQS("website");
        details.set("website", website);

        // type
        details.set("type", getQS("type") || "mobile");

        // date
        details.set("date", getQS("date") || "2023-08-08");

        // webpage
        details.set("webpage", getQS("webpage") || "/");

        // baseUrl        
        details.set("baseUrl", `https://section508pro.github.io/508-${website}-data`);

        // dateUrl 
        details.set("dateUrl", `${details.get("baseUrl")}/reports/${details.get("type")}/${details.get("date")}`);
        
        // pageUrl
        details.set("pageUrl", `${details.get("dateUrl")}/reports${details.get("webpage")}`);

        // jsonAllPages
        details.set("jsonAllPages", `${details.get("dateUrl")}/ci-result.json`);

        // jsonErrorsSummaryLighthouse
        details.set("jsonErrorsSummaryLighthouse", `${details.get("dateUrl")}/errors-summary-lighthouse.json`);

        // jsonErrorsSummaryWcag
        details.set("jsonErrorsSummaryWcag", `${details.get("dateUrl")}/errors-summary-wcag.json`);

        // htmlLighthouse
        details.set("htmlLighthouse", `${details.get("pageUrl")}/lighthouse.html`);

        // jsonLighthouse
        details.set("jsonLighthouse", `${details.get("pageUrl")}/lighthouse.json`);

        // jsonA11y
        details.set("jsonA11y", `${details.get("pageUrl")}/a11y.json`);

        // jsonA11yErrors
        details.set("jsonA11yErrors", `${details.get("pageUrl")}/a11y-errors.json`);

        return details;
      }

      /**
       * Fetches remote json, throws "newdata" event
       */ 
       async function fetchJson(key){
        const details = getDetails();
        fetch(details.get(key))
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Problem fetching ${key}: ${response.status}`);
            }
            return response.json();
          })
          .then((json) => {
            window.dispatchEvent(new CustomEvent("newdata", {
              detail: {
                key: key,
                json: json
              }
            }));
            return;
          })
          .catch((err) => {
            console.error(err);
          });
      }



      /**
       * Saves remote json to sessionStorage
       */ 
      async function saveJson(key){
        const details = getDetails();
        fetch(details.get(key))
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Problem fetching ${key}: ${response.status}`);
            }
            return response.json();
          })
          .then((json) => {
            sessionStorage.setItem(key, JSON.stringify(json, null, 2));
            return;
          })
          .catch((err) => {
            console.error(err);
          });
      }

      /**
       * Returns WCAG SC (Success Criteria) for Lighthouse audit key
       * Example: "link-name": ["2.4.4", "4.1.2"]
       */ 
      function lh2wcag(lhKey){
        const rules = {
          // WCAG 2.0 A and AA
          //"aria-alt": ["1.1.1", "2.4.4", "4.1.2"],
          "aria-allowed-attr": ["4.1.2"],
          "aria-command-name": ["4.1.2"],
          "aria-hidden-body": ["4.1.2"],
          "aria-hidden-focus": ["1.3.1", "4.1.2"],
          "aria-input-field-name": ["4.1.2"],
          "aria-meter-name": ["1.1.1"],
          "aria-progressbar-name": ["1.1.1"],
          "aria-required-attr": ["4.1.2"],
          "aria-required-children": ["1.3.1"],
          "aria-required-parent": ["1.3.1"],
          //"aria-roledescription": ["4.1.2"],
          "aria-roles": ["4.1.2"],
          "aria-toggle-field-name": ["4.1.2"],
          "aria-tooltip-name": ["4.1.2"],
          "aria-valid-attr-value": ["4.1.2"],
          "aria-valid-attr": ["4.1.2"],
          //"audio-caption": ["1.2.1"],
          //"blink": ["2.2.2"],
          "button-name": ["4.1.2"],
          "bypass": ["2.4.1"],
          "color-contrast": ["1.4.3"],
          "definition-list": ["1.3.1"],
          //"dl-item": ["1.3.1"],
          "document-title": ["2.4.2"],
          "duplicate-id-active": ["4.1.1"],
          "duplicate-id-aria": ["4.1.1"],
          //"duplicate-id": ["4.1.1"],
          "form-field-multiple-labels": ["3.3.2"],
          //"frame-focusable-content": ["2.1.1"],
          "frame-title": ["2.4.1", "4.1.2"],
          "html-has-lang": ["3.1.1"],
          "html-lang-valid": ["3.1.1"],
          //"html-xml-lang-mismatch": ["3.1.1"],
          "image-alt": ["1.1.1"],
          //"input-button-name": ["4.1.2"],
          "input-image-alt": ["1.1.1"],
          "label": ["1.3.1", "4.1.2"],          
          "link-name": ["2.4.4", "4.1.2"],
          "list": ["1.3.1"],
          "listitem": ["1.3.1"],
          //"marquee": ["2.2.2"],
          "meta-refresh": ["2.2.1", "2.2.4", "3.2.5"],
          //"nested-interactive": ["4.1.2"],
          "object-alt": ["1.1.1"],
          //"role-img-alt": ["1.1.1"],
          //"scrollable-region-focusable": ["2.1.1"],
          //"select-name": ["1.3.1", "4.1.2"],
          //"server-side-image-map": ["2.1.1"],
          //"svg-img-alt": ["1.1.1"],
          "td-headers-attr": ["1.3.1"],
          //"td-has-data-cells": ["1.3.1"],
          "valid-lang": ["3.1.2"],
          "video-caption": ["1.2.2"]
          // WCAG 2.1 A and AA
          //"autocomplete-valid": ["1.3.5"],
          //"avoid-inline-spacing": ["1.4.1"],
          //"empty-table-header": ["1.3.1"],
          // WCAG 2.0 and 2.1 AAA
          //"color-contrast-enhanced": ["1.4.6"],
          //"identical-links-same-purpose": ["2.4.9"],
          // AXE Experimental
          //"css-orientation-lock": ["1.3.4"],
          //"label-content-name-mismatch": ["2.5.3"],
          //"link-in-text-block": ["1.4.1"],
          //"no-autoplay-audio": ["1.4.2"],
          //"p-as-heading": ["1.3.1"],
          //"table-fake-caption": ["1.3.1"],
          //"td-has-header": ["1.3.1"]
        };
        return rules[lhKey] || [];
      }


    </script>
  </head>

  <body>
  <a class="usa-skipnav" href="#main-content">Skip to main content</a>

  <!-- usa-header -->
  <div class="usa-overlay"></div>
  <header class="usa-header usa-header--basic">
    <div class="usa-nav-container">
      <div class="usa-navbar">
        <div class="usa-logo" id="-logo">
          <em class="usa-logo__text"
              ><a href="/" title="SBA Section 508 Dashboard">Section 508 Pro</a></em
          >
        </div>
        <button type="button" class="usa-menu-btn">Menu</button>
      </div>
      <nav aria-label="Primary navigation," class="usa-nav">
        <button type="button" class="usa-nav__close">
          <img src="/assets/uswds/img/usa-icons/close.svg" role="img" alt="Close" />
        </button>
        <ul class="usa-nav__primary usa-accordion">
          <li class="usa-nav__primary-item">
            <a href="/public.html" class="usa-nav-link"><span>Public Webpages</span></a>
          </li>
          <li class="usa-nav__primary-item">
            <a href="/internal.html" class="usa-nav-link"><span>Internal Webpages</span></a>
          </li>
          <li class="usa-nav__primary-item">
            <a href="/documents.html" class="usa-nav-link"><span>Public Documents</span></a>
          </li>
          <li class="usa-nav__primary-item">
            <a href="/assessment.html" class="usa-nav-link"><span>Full Assessment</span></a>
          </li>
        </ul>
        <section aria-label="Search component">
          <form class="usa-search usa-search--small" role="search">
            <label class="usa-sr-only" for="search-field">Search</label>
            <input
              class="usa-input"
              id="search-field"
              type="search"
              name="search"
            />
            <button class="usa-button" type="submit">
              <img
                src="/assets/uswds/img/usa-icons-bg/search--white.svg"
                class="usa-search__submit-icon"
                alt="Search"
              />
            </button>
          </form>
        </section>
      </nav>
    </div>
  </header>
  <!-- usa-header -->

  <!-- usa-section -->
  <div class="usa-section">
    <div class="grid-container-widescreen">
      <div class="grid-row grid-gap">

        <!-- sidebar navigation -->
        <div class="usa-layout-docs__sidenav desktop:grid-col-3">
          <nav aria-label="Secondary navigation">
            <ul class="usa-sidenav">
              <li class="usa-sidenav__item">
                <a href="public.html">Summary</a>
              </li>
              <li class="usa-sidenav__item">
                <a href="history.html">History</a>
              </li>
              <li class="usa-sidenav__item">
                <a href="agencies.html">Federal Agencies</a>
                <agency-nav></agency-nav>
              </li>
            </ul>
          </nav>
        </div>



        <main
          class="
            usa-layout-docs__main
            desktop:grid-col-9
            usa-prose usa-layout-docs
          "
          id="main-content"
        >
          <h1 id="main-header">View</h1>
          <p class="usa-intro">
          </p>

          <div class="grid-container">
            <div class="grid-row">
              <div class="tablet:grid-col">
                <h2>WCAG</h2>
                <wcag-errors id="wcagErrors"></wcag-errors>
                <wcag-form></wcag-form>
              </div>

              <div class="tablet:grid-col">
                <h2>Lighthouse</h2>
                <error-table id="lhErrorTable" data-error-type="lighthouse"></error-table>
                <iframe src=""
                        id="lighthouse-html"
                        width="100%"
                        height="1000px"></iframe>
              </div>
            </div>
          </div>




        </main>
      </div>
    </div>
  </div>
  <footer class="usa-footer">
    <div class="grid-container usa-footer__return-to-top">
      <a href="#">Return to top</a>
    </div>

    <div class="usa-footer__secondary-section">
      <div class="grid-container">
        <div class="grid-row grid-gap">
          <div
            class="
              usa-footer__logo
              grid-row
              mobile-lg:grid-col-6 mobile-lg:grid-gap-2
            "
          >
            <div class="mobile-lg:grid-col-auto">
              <img
                class="usa-footer__logo-img"
                src="/assets/uswds/img/logo-img.png"
                alt=""
              />
            </div>
            <div class="mobile-lg:grid-col-auto">
              <p class="usa-footer__logo-heading">Skyward IT Solutions</p>
            </div>
          </div>
          <div class="usa-footer__contact-links mobile-lg:grid-col-6">
            <div class="usa-footer__social-links grid-row grid-gap-1">
              <div class="grid-col-auto">
                <a class="usa-social-link" href="javascript:void(0);"
                  ><img
                    class="usa-social-link__icon"
                    src="/assets/uswds/img/usa-icons/facebook.svg"
                    alt="Facebook"
                /></a>
              </div>
              <div class="grid-col-auto">
                <a class="usa-social-link" href="javascript:void(0);"
                  ><img
                    class="usa-social-link__icon"
                    src="/assets/uswds/img/usa-icons/twitter.svg"
                    alt="Twitter"
                /></a>
              </div>
              <div class="grid-col-auto">
                <a class="usa-social-link" href="javascript:void(0);"
                  ><img
                    class="usa-social-link__icon"
                    src="/assets/uswds/img/usa-icons/youtube.svg"
                    alt="YouTube"
                /></a>
              </div>
              <div class="grid-col-auto">
                <a class="usa-social-link" href="javascript:void(0);"
                  ><img
                    class="usa-social-link__icon"
                    src="/assets/uswds/img/usa-icons/instagram.svg"
                    alt="Instagram"
                /></a>
              </div>
              <div class="grid-col-auto">
                <a class="usa-social-link" href="javascript:void(0);"
                  ><img
                    class="usa-social-link__icon"
                    src="/assets/uswds/img/usa-icons/rss_feed.svg"
                    alt="RSS"
                /></a>
              </div>
            </div>
            <p class="usa-footer__contact-heading">
              Contact us
            </p>
            <address class="usa-footer__address">
              <div class="usa-footer__contact-info grid-row grid-gap">
                <div class="grid-col-auto">
                  <a href="tel:410-449-3003">(410) 449-3003</a>
                </div>
                <div class="grid-col-auto">
                  <a href="mailto:info@skywarditsolutions.com">info@skywarditsolutions.com</a>
                </div>
              </div>
            </address>
          </div>
        </div>
      </div>
    </div>
  </footer>

      <script src="assets/uswds/dist/js/uswds.min.js"></script>
  </body>
</html>
